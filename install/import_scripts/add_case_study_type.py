from flask import g

from openatlas import app

sql = """
--make all places from current THANADOS ids tagged
INSERT INTO model.link (domain_id, property_code, range_id)
SELECT id, 'P2', 181731
FROM model.entity
WHERE id IN
      (126883, 126903, 127381, 128117, 128281, 129798, 129809, 130524, 130581, 130585, 131121, 131127, 131134,
              131179, 132678, 133639, 134779, 134787, 134790, 136515, 136584, 136595, 136598, 143158, 143182, 143205,
              143240, 154745, 156442, 156451, 156468, 156478, 156493, 156495, 156533, 156543, 156949, 157253, 157809,
              158072, 158085, 158273, 158275, 158301, 158861, 158867, 158871, 158873, 158875, 158877, 158879, 159087,
              159098, 159109, 159371, 159402, 159539, 161236, 161245, 171980, 171998, 172011, 172020, 172029, 172041,
              172066, 172211, 172393, 172462, 174384, 174398, 174407, 174419, 174456, 174482, 174744, 174755, 174762,
              176118, 179309, 179311, 179313, 179315, 179317, 179319, 179321, 179323, 179325, 179327, 179329, 179331,
              179333, 179335, 179337, 179339, 179341, 179471, 179473, 179477, 181172, 181189, 181193, 181281, 181457,
              181634, 181636, 182268, 182271, 182274, 182278, 182948, 182950, 184621, 184635, 184638, 184641, 185004,
              185028, 185127, 45097, 45143, 45161, 45167, 45173, 45179, 45735, 45741, 45751, 45753, 45761, 45767, 45773,
              45779, 45781, 45789, 45795, 45797, 45811, 45813, 134748, 141276, 143102, 156726, 157597, 157849, 157857,
              157891, 158155, 158385, 158543, 158545, 158572, 159212, 159227, 159240, 159260, 159305, 159351, 159682,
              161292, 161301, 161337, 172095, 172378, 172493, 172518, 172682, 173041, 174510, 174523, 174550, 174605,
              174612, 175496, 175811, 179275, 179279, 179281, 179283, 179285, 179287, 179289, 179291, 179293, 179295,
              179297, 179299, 179301, 179303, 179305, 179307, 179343, 179345, 179347, 179349, 179351, 179353, 179355,
              179357, 179359, 179361, 179365, 179367, 179369, 179371, 179373, 179375, 179377, 179379, 179381, 179383,
              179385, 179387, 179389, 179391, 179393, 179395, 179397, 179399, 179401, 179403, 179405, 179407, 179409,
              179411, 179413, 179415, 179417, 179419, 179421, 179423, 179425, 179427, 179429, 179431, 179433, 179435,
              179437, 179439, 179441, 179443, 179445, 179447, 179449, 179451, 179453, 179455, 179457, 179459, 179461,
              179463, 179465, 179467, 179469, 179657, 179661, 179664, 181213, 181546, 181732, 181735, 182025, 182028,
              182031, 182034, 182037, 182040, 182043, 182111, 182117, 182152, 182494, 182987, 182991, 182994, 182998,
              183002, 183007, 183010, 183012, 184654, 184658, 184668, 184744, 184751, 184754, 185169, 189755, 45185,
              45191, 45197, 45337, 45423, 45457, 45463, 45609, 45615, 45621, 45623, 45625, 45631, 45649, 45651, 45653,
              45659, 45665, 45673, 45675, 45681, 45687, 45693, 45699, 45701, 45707, 45715, 45721, 45723, 45729, 46255,
              46261, 46267, 46273, 46275, 46281, 46287, 46289, 46295, 46301, 46307, 46313, 46319, 46325, 46331, 46337,
              46339, 46341, 46347, 46353, 46359, 46365, 46371, 46377, 46379, 46385, 46391, 46397, 46403, 46409, 46415,
              46421, 46427, 46569, 46581, 46583, 46591, 46607, 46613, 46625, 46691, 46713, 46715, 46747, 46753, 46759,
              46855, 46883, 46889, 46927, 46957, 46969, 46989, 46991, 47011, 47013, 47017, 47037, 45819, 45825, 45831,
              45837, 45843, 45849, 45855, 45861, 45867, 45873, 46243, 46249, 111285, 119152, 124592, 124633, 125161,
              125164, 125167, 47049, 47057, 47059, 47061, 47063, 47065, 47067, 47069, 47071, 47073, 47079, 47085, 47093,
              47105, 47113, 47119, 47151, 47165, 47171, 47179, 47205, 47249, 47273, 47343, 47361, 47363, 47381, 47383,
              47425, 47431, 47435, 47453, 47477, 47489, 47523, 47525, 47563, 47571, 47577, 47597, 47693, 47713, 47723,
              47807, 47809, 47811, 47819, 47831, 47837, 47845, 47877, 47881, 47883, 47909, 47935, 47951, 47959, 48095,
              48141, 48177, 48183, 48189, 48197, 48201, 48207, 48233, 48239, 48247, 48249, 48261, 48299, 48507, 48515,
              48569, 48575, 48657, 48699, 48705, 48711, 48717, 48729, 48731, 48743, 48755, 48773, 48785, 48791, 48797,
              48803, 48809, 48815, 48821, 48827, 48875, 48893, 48929, 48983, 48989, 49001, 49013, 49037, 49043, 49121,
              49127, 49133, 49135, 49153, 49177, 49217, 49223, 49229, 49241, 49255, 49289, 49307, 49309, 49381, 49405,
              49417, 49429, 49435, 49443, 49449, 49457, 49463, 49477, 49491, 49497, 49505, 49513, 49533, 49611, 49631,
              49637, 49735, 49747, 49753, 49759, 49765, 50305, 50311, 50329, 50349, 50397, 50421, 50461, 50473, 50495,
              50497, 50503, 50505, 50517, 50565, 50571, 50577, 50583, 50589, 50591, 50597, 50625, 50665, 118196, 118742,
              119224, 120277, 124567, 124686, 125095, 194855)
         AND id NOT IN (SELECT domain_id
                        FROM model.link
                        WHERE range_id = 181731);

-- tag features, strat units, finds and bones too.
INSERT INTO model.link (domain_id, property_code, range_id)
SELECT range_id AS domain_id, 'P2' AS property_code, 181731 AS range_id
FROM (SELECT range_id
      FROM model.link
      WHERE property_code = 'P46'
        AND domain_id IN
            (SELECT domain_id
             FROM model.link
             WHERE range_id = 181731
               AND property_code = 'P2')
        AND domain_id IN (SELECT id from model.entity WHERE openatlas_class_name = 'place')
        AND range_id IN (SELECT id from model.entity WHERE openatlas_class_name = 'feature')
        AND range_id NOT IN (SELECT domain_id
                             FROM model.link
                             WHERE range_id = 181731
                               AND property_code = 'P2')) a;

INSERT INTO model.link (domain_id, property_code, range_id)
SELECT range_id AS domain_id, 'P2' AS property_code, 181731 AS range_id
FROM (SELECT range_id
      FROM model.link
      WHERE property_code = 'P46'
        AND domain_id IN
            (SELECT domain_id
             FROM model.link
             WHERE range_id = 181731
               AND property_code = 'P2')
        AND domain_id IN (SELECT id from model.entity WHERE openatlas_class_name = 'feature')
        AND range_id IN (SELECT id from model.entity WHERE openatlas_class_name = 'stratigraphic_unit')
        AND range_id NOT IN (SELECT domain_id
                             FROM model.link
                             WHERE range_id = 181731
                               AND property_code = 'P2')) a;

INSERT INTO model.link (domain_id, property_code, range_id)
SELECT range_id AS domain_id, 'P2' AS property_code, 181731 AS range_id
FROM (SELECT range_id
      FROM model.link
      WHERE property_code = 'P46'
        AND domain_id IN
            (SELECT domain_id
             FROM model.link
             WHERE range_id = 181731
               AND property_code = 'P2')
        AND domain_id IN (SELECT id from model.entity WHERE openatlas_class_name = 'stratigraphic_unit')
        AND range_id IN (SELECT id from model.entity WHERE openatlas_class_name IN ('artifact', 'human_remains'))
        AND range_id NOT IN (SELECT domain_id
                             FROM model.link
                             WHERE range_id = 181731
                               AND property_code = 'P2')) a;

"""

def update_case_study_for_thanados():
    with app.test_request_context():
        app.preprocess_request()
        conn = g.cursor.connection
        try:
            g.cursor.execute(sql)
            conn.commit()
        except Exception as e:
            conn.rollback()
            raise

update_case_study_for_thanados()
